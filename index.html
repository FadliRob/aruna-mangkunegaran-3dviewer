<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>3D Walkthrough - Mangkunegaran</title>
<style>
    body, html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        background: #000;
    }

    /* Virtual Joystick */
    #joystickContainer {
        position: fixed;
        left: 20px;
        bottom: 20px;
        width: 120px;
        height: 120px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        backdrop-filter: blur(4px);
        touch-action: none;
        display: none;
    }

    #joystick {
        position: absolute;
        width: 60px;
        height: 60px;
        background: rgba(255,255,255,0.4);
        border-radius: 50%;
        top: 30px;
        left: 30px;
    }
</style>
</head>
<body>

<div id="joystickContainer"><div id="joystick"></div></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/examples/js/loaders/RGBELoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/examples/js/controls/PointerLockControls.js"></script>

<script>
let scene, camera, renderer, mixer;
let controls;
let velocity = new THREE.Vector3();
let direction = new THREE.Vector3();

// Detect mobile
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

// Scene
scene = new THREE.Scene();

// Camera
camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 500);
camera.position.set(0, 1.6, 5);

// Renderer
renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.outputEncoding = THREE.sRGBEncoding;
document.body.appendChild(renderer.domElement);

// ⭐⭐⭐ LOAD HDR ⭐⭐⭐
new THREE.RGBELoader()
    .setPath("./")
    .load("env.hdr", function (hdrMap) {
        hdrMap.mapping = THREE.EquirectangularReflectionMapping;
        scene.environment = hdrMap;
        scene.background = hdrMap;  // jika mau background warna HDR
    });

// Pointer Lock (Desktop FPS)
controls = new THREE.PointerLockControls(camera, document.body);

if (!isMobile) {
    document.body.addEventListener('click', () => {
        controls.lock();
    });
}

// Ambient light
scene.add(new THREE.AmbientLight(0xffffff, 1.5));

// Load Model
const loader = new THREE.GLTFLoader();
loader.load("Mangkunegaran.glb", gltf => {

    const model = gltf.scene;

    // Auto center
    const box = new THREE.Box3().setFromObject(model);
    const center = box.getCenter(new THREE.Vector3());
    model.position.sub(center);

    model.position.y = 0;

    scene.add(model);
});

// Desktop movement keys
const keys = { w:false, a:false, s:false, d:false };

document.addEventListener("keydown", e => { if (keys[e.key] !== undefined) keys[e.key] = true; });
document.addEventListener("keyup",   e => { if (keys[e.key] !== undefined) keys[e.key] = false; });

// Virtual joystick (mobile)
const joyContainer = document.getElementById("joystickContainer");
const joystick = document.getElementById("joystick");

if (isMobile) joyContainer.style.display = "block";

let joyX = 0, joyY = 0;

joyContainer.addEventListener("touchstart", () => {});

joyContainer.addEventListener("touchmove", e => {
    const t = e.touches[0];
    const rect = joyContainer.getBoundingClientRect();
    const x = t.clientX - rect.left - 60;
    const y = t.clientY - rect.top - 60;
    const dist = Math.sqrt(x*x + y*y);

    if (dist < 40) {
        joystick.style.left = x + 60 + "px";
        joystick.style.top = y + 60 + "px";
        joyX = x/40;
        joyY = y/40;
    }
});

joyContainer.addEventListener("touchend", () => {
    joystick.style.left = "30px";
    joystick.style.top = "30px";
    joyX = joyY = 0;
});

// Animation Loop
function animate() {
    requestAnimationFrame(animate);

    const speed = 0.06;

    if (isMobile) {
        direction.x = joyX;
        direction.z = joyY;
    } else {
        direction.z = Number(keys.w) - Number(keys.s);
        direction.x = Number(keys.d) - Number(keys.a);
    }

    if (direction.length() > 0) {
        direction.normalize();
        const moveX = direction.x * speed;
        const moveZ = direction.z * speed;

        const forward = new THREE.Vector3();
        controls.getDirection(forward);
        forward.y = 0;
        forward.normalize();

        const right = new THREE.Vector3();
        right.crossVectors(camera.up, forward).normalize().multiplyScalar(-1);

        camera.position.add(forward.multiplyScalar(moveZ));
        camera.position.add(right.multiplyScalar(moveX));
    }

    renderer.render(scene, camera);
}
animate();

// Resize
window.addEventListener("resize", ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
